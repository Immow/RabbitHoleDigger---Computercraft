-- Turtle rabbit hole dig program v1.3 by Immow (optimized by Koen's AI buddy) --

-- Global Variables
print("Specify amount of rabbit holes to dig")
print("Put an enderchest in bottom right inventory slot for unloading")
local h = tonumber(read()) or 0
print("Holes to dig:", h)
local count = 0

-- List of blocks we want to ignore (do not mine)
local materials = {
	["minecraft:stone"] = true,
	["minecraft:grass"] = true,
	["minecraft:gravel"] = true,
	["minecraft:dirt"] = true,
	["minecraft:sand"] = true,
	["minecraft:sandstone"] = true,
	["chissl:basalt2"] = true,
}

-- Unload inventory into an ender chest (slot 16 reserved)
local function unload()
	turtle.digUp()
	turtle.select(16)
	if turtle.placeUp() then
		for i = 1, 15 do
			turtle.select(i)
			turtle.dropUp()
		end
		turtle.select(16)
		turtle.digUp()
	else
		print("Failed to place ender chest for unloading!")
	end
	turtle.select(1)
end

-- Movement pattern for "horse jump" step
local function horseJump()
	forwardAndDig()
	forwardAndDig()
	turtle.turnLeft()
	forwardAndDig()
	turtle.turnRight()
end

-- Helper: dig & move forward
function forwardAndDig()
	while not turtle.forward() do
		turtle.dig()
		os.sleep(0.2)
	end
end

-- Place block under turtle if we moved down
local function placeBlock(direction)
	if count < -1 then
		for i = 1, 15 do
			local detail = turtle.getItemDetail(i)
			if detail and materials[detail.name] then
				turtle.select(i)
				if direction == "down" then
					turtle.placeUp() -- replace block above when digging down
				else
					turtle.placeDown() -- replace block below when digging up
				end
				break
			end
		end
	end
end

-- Dig only blocks not in materials list
local function dig()
	local success, data = turtle.inspect()
	if success and not materials[data.name] then
		turtle.dig()
		if turtle.getItemCount(15) > 0 then
			unload()
		end
	end
end

-- Fuel management
local function refuel()
	while turtle.getFuelLevel() < 500 do
		term.clear()
		term.setCursorPos(1, 1)
		print("Fuel level =", turtle.getFuelLevel())
		print("Please insert fuel in slot 1")
		print("Hold CTRL+T to terminate")
		os.sleep(5)
		turtle.select(1)
		turtle.refuel()
	end
end

-- Dig downward --
local function shaftDown()
	while true do
		local success, data = turtle.inspectDown()
		if success and data.name == "minecraft:bedrock" then
			break
		end
		turtle.digDown()
		if turtle.down() then
			count = count - 1
			for _ = 1, 4 do
				dig()
				turtle.turnRight()
			end
			placeBlock("down")
		end
	end
end

-- Dig upward --
local function shaftUp()
	while count < 0 do
		turtle.digUp()
		if turtle.up() then
			count = count + 1
			for _ = 1, 4 do
				dig()
				turtle.turnRight()
			end
			placeBlock("up")
		end
	end
end


-- Main Execution
refuel()
for _ = 1, h do
	shaftDown()
	horseJump()
	shaftUp()
	horseJump()
	unload()
end
